<UserControl xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Highbyte.DotNet6502.App.Avalonia.Core.ViewModels"
        x:Class="Highbyte.DotNet6502.App.Avalonia.Core.Views.C64ConfigUserControl"
        x:DataType="vm:C64ConfigDialogViewModel">
  
  <!-- Simplified layout for ContentDialog - no outer border needed -->
  <Grid RowDefinitions="Auto,*,Auto,Auto" Margin="8,0,8,8">
    <!-- Title Header -->
    <Border Grid.Row="0" CornerRadius="4,4,4,4" Classes="panel-container">
      <TextBlock Text="Commodore 64 Configuration"
                 Classes="h-center h2"/>
    </Border>

    <!-- Main content with wrapping layout - scrollable -->
    <ScrollViewer Grid.Row="1" Classes="vertical-only">
      <WrapPanel Orientation="Horizontal"> 
      
        <!-- ROM Section -->
        <StackPanel Width="460" Classes="wrap-item">
        <Border Classes="content-section">
            <StackPanel Classes="spacing-tight">
            <TextBlock Text="ROM Management"
                        Classes=""/>
            <TextBlock Text="The emulator requires Kernal, Basic, and Character ROMs."
                        Classes="small secondary-text"/>
            <TextBlock Text="{Binding RomStatusSummary}"
                        Classes="accent bold"/>

            <ItemsControl ItemsSource="{Binding RomStatuses}">
                <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:RomStatusViewModel">
                    <StackPanel Classes="spacing-tight">
                    <!-- WebAssembly version - display only -->
                    <Grid ColumnDefinitions="90,*" Classes="spacing-tight"
                            IsVisible="{Binding IsRunningInWebAssembly}">
                        <TextBlock Grid.Column="0" 
                                    Text="{Binding Name}:"
                                    Classes="secondary-text"/>
                        <TextBlock Grid.Column="2" 
                                    Text="{Binding Details}"
                                    Foreground="{Binding ForegroundColor}"/>
                    </Grid>

                    <!-- Desktop version - editable File name -->
                    <Grid ColumnDefinitions="90,*" Classes="spacing-tight"
                            IsVisible="{Binding !IsRunningInWebAssembly}">
                        <TextBlock Grid.Column="0" 
                                    Text="{Binding Name}:"
                                    Classes="secondary-text"/>
                        <TextBox Grid.Column="1" 
                                Text="{Binding RomFile, Mode=TwoWay}"
                                Watermark="File name"
                                Classes="field-aligned"/>
                    </Grid>
                    </StackPanel>
                </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- ROM Directory setting (only for desktop) -->
            <StackPanel Classes="spacing-tight">
                <Grid ColumnDefinitions="90,*" Classes="spacing-tight"
                    IsVisible="{Binding !IsRunningInWebAssembly}">
                    <TextBlock Grid.Column="0"
                                Text="ROM directory:"
                                Classes="secondary-text"/>
                    <TextBox Grid.Column="1"
                            Text="{Binding RomDirectory}"
                            Watermark="Directory path"
                            Classes="field-aligned"/>
                </Grid>
            </StackPanel>


            <StackPanel Orientation="Horizontal" Classes="spacing-normal">
                <!-- Clear for WASM app to clear ROM byte arrays -->
                <Button Content="Clear"
                        Command="{Binding ClearRomsCommand}"
                        MinWidth="90"
                        Classes="danger"
                        IsVisible="{Binding IsRunningInWebAssembly}"
                        IsEnabled="{Binding IsNotBusy}"/>
                <!-- Load button for WASM app to files via file picker to in-memory byte array -->
                <Button Content="Load ROMs from files"
                        MinWidth="150"
                        Classes="extraWide"
                        IsVisible="{Binding IsRunningInWebAssembly}"
                        IsEnabled="{Binding IsNotBusy}"
                        Click="LoadRoms_Click"/>
                <!-- Download button for WASM app to in-memory byte array -->
                <Button Content="Download ROMs"
                        Command="{Binding DownloadRomsToByteArrayCommand}"
                        MinWidth="130"
                        Classes="primary wide"
                        IsVisible="{Binding IsRunningInWebAssembly}"
                        IsEnabled="{Binding IsNotBusy}"/>

                <!-- Download button for Desktop app to files -->
                <Button Content="Download ROM Files"
                        Command="{Binding DownloadRomsToFilesCommand}"
                        MinWidth="130"
                        Classes="primary extraWide"
                        IsVisible="{Binding !IsRunningInWebAssembly}"
                        IsEnabled="{Binding IsNotBusy}"/>                    
            </StackPanel>

            </StackPanel>
        </Border>
        </StackPanel>
          
        <!-- Render Section -->
        <StackPanel Width="460" Classes="wrap-item">
            <Border Classes="content-section">
                <StackPanel Classes="spacing-tight">
                <TextBlock Text="Video"
                            Classes=""/>

                <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" Classes="spacing-tight">
                    <TextBlock Grid.Row="0" Grid.Column="0" 
                                Text="Render provider:" 
                                Classes="secondary-text"/>
                    <ComboBox Grid.Row="0" Grid.Column="1"
                            ItemsSource="{Binding RenderProviders}"
                            SelectedItem="{Binding SelectedRenderProvider}"
                            ToolTip.Tip="{Binding SelectedRenderProviderHelpText}"
                            Classes="h-stretch"
                            MaxDropDownHeight="200">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:RenderProviderOption">
                            <TextBlock Text="{Binding DisplayName}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <TextBlock Grid.Row="1" Grid.Column="0" 
                                Text="Render target:" 
                                Classes="secondary-text"/>
                    <ComboBox Grid.Row="1" Grid.Column="1"
                            ItemsSource="{Binding RenderTargets}"
                            SelectedItem="{Binding SelectedRenderTarget}"
                            ToolTip.Tip="{Binding SelectedRenderTargetHelpText}"
                            Classes="h-stretch"
                            MaxDropDownHeight="200">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:RenderTargetOption">
                            <TextBlock Text="{Binding DisplayName}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </Grid>

                </StackPanel>
            </Border>
        </StackPanel>

        <!-- Audio Section -->
        <StackPanel Width="460" Classes="wrap-item">
            <Border Classes="content-section">
                <StackPanel Classes="spacing-tight">
                    <TextBlock Text="Audio"
                                Classes=""/>

                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" Classes="spacing-tight">
                        <CheckBox Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                                Content="Enable SID audio (experimental)"
                                IsChecked="{Binding AudioEnabled}"
                                Classes=""/>
                    </Grid>
                </StackPanel>
            </Border>
        </StackPanel>

        <!-- Input Section -->
        <StackPanel Width="460" Classes="wrap-item">
        <Border Classes="content-section">
            <StackPanel Classes="spacing-tight">
            <TextBlock Text="Input &amp; Joystick"
                        Classes=""/>

            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" Classes="spacing-wide">
                <TextBlock Grid.Row="0" Grid.Column="0" 
                            Text="Active joystick port:" 
                            Classes="secondary-text"
                            IsEnabled="false" />
                <ComboBox Grid.Row="0" Grid.Column="1"
                        ItemsSource="{Binding AvailableJoysticks}"
                        SelectedItem="{Binding SelectedHostJoystick}"
                        Classes="small"
                        MinWidth="80"
                        MaxDropDownHeight="100"
                        IsEnabled="false" />

                <CheckBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                        Content="Enable keyboard joystick controls"
                        IsChecked="{Binding KeyboardJoystickEnabled}"
                        Classes=""/>

                <TextBlock Grid.Row="2" Grid.Column="0" 
                            Text="Keyboard joystick port:" 
                            Classes="secondary-text"/>
                <ComboBox Grid.Row="2" Grid.Column="1"
                        ItemsSource="{Binding AvailableJoysticks}"
                        SelectedItem="{Binding SelectedKeyboardJoystick}"
                        Classes="small"
                        MinWidth="80"
                        MaxDropDownHeight="100"/>
            </Grid>

            <!-- Collapsible Keyboard Mappings Section -->
            <Expander Header="Keyboard mappings"
                        Classes="small secondary-text"
                        IsExpanded="False">
                <ItemsControl ItemsSource="{Binding KeyboardMappings}"
                            Classes="">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:KeyMappingEntry">
                    <DockPanel>
                        <TextBlock Text="{Binding Action}"
                                    Classes="secondary-text"
                                    Width="100"/>
                        <TextBlock Text="{Binding Key}"/>
                    </DockPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Expander>
            </StackPanel>
        </Border>
        </StackPanel>

        <!-- AI Coding Assistant Section -->
        <StackPanel Width="460" Classes="wrap-item">
        <Border Classes="content-section">
            <StackPanel Classes="spacing-tight">
            <StackPanel Orientation="Horizontal" Classes="spacing-tight">
                <TextBlock Text="Basic AI Coding Assistant"
                            Classes=""/>
                <Button Content="i"
                        Classes="info"
                        ToolTip.Tip="Click for more information about the AI coding assistant"
                        Click="OpenAIHelpUrl_Click"/>
            </StackPanel>

            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" Classes="spacing-tight">
                <TextBlock Grid.Row="0" Grid.Column="0" 
                            Text="AI backend type:" 
                            Classes="secondary-text"/>
                <ComboBox Grid.Row="0" Grid.Column="1"
                        ItemsSource="{Binding AIBackendTypes}"
                        SelectedItem="{Binding SelectedAIBackendTypeOption}"
                        Classes="h-stretch">
                    <ComboBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:CodeSuggestionBackendTypeOption">
                            <TextBlock Text="{Binding DisplayName}"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <!-- OpenAI Settings -->
                <TextBlock Grid.Row="1" Grid.Column="0" 
                        Text="OpenAI API key:" 
                        Classes="secondary-text"
                        IsVisible="{Binding ShowOpenAISettings}"/>
                <TextBox Grid.Row="1" Grid.Column="1"
                        Text="{Binding OpenAIApiKey}"
                        Watermark="Enter OpenAI API key"
                        Classes=""
                        IsVisible="{Binding ShowOpenAISettings}"/>

                <!-- Self-Hosted Settings -->
                <TextBlock Grid.Row="2" Grid.Column="0" 
                        Text="Ollama endpoint:" 
                        Classes="secondary-text"
                        IsVisible="{Binding ShowSelfHostedSettings}"/>
                <TextBox Grid.Row="2" Grid.Column="1"
                        Text="{Binding OpenAISelfHostedEndpoint}"
                        Watermark="http://localhost:11434/api"
                        Classes=""
                        IsVisible="{Binding ShowSelfHostedSettings}"/>

                <TextBlock Grid.Row="3" Grid.Column="0" 
                        Text="Model name:" 
                        Classes="secondary-text"
                        IsVisible="{Binding ShowSelfHostedSettings}"/>
                <TextBox Grid.Row="3" Grid.Column="1"
                        Text="{Binding OpenAISelfHostedModelName}"
                        Watermark="codellama:13b-code"
                        Classes=""
                        IsVisible="{Binding ShowSelfHostedSettings}"/>

                <TextBlock Grid.Row="4" Grid.Column="0" 
                        Text="API key (optional):" 
                        Classes="secondary-text"
                        IsVisible="{Binding ShowSelfHostedSettings}"/>
                <TextBox Grid.Row="4" Grid.Column="1"
                        Text="{Binding OpenAISelfHostedApiKey}"
                        Watermark="Optional API key"
                        Classes=""
                        IsVisible="{Binding ShowSelfHostedSettings}"/>

                <TextBlock Grid.Row="5" Grid.Column="0" 
                        Text="Endpoint API key:" 
                        Classes="secondary-text"
                        IsVisible="{Binding ShowCustomEndpointSettings}"/>
                <TextBox Grid.Row="5" Grid.Column="1"
                        Text="{Binding CustomEndpointApiKey}"
                        Watermark="API key - leave blank for default"
                        Classes=""
                        IsVisible="{Binding ShowCustomEndpointSettings}"/>
            </Grid>

            <!-- Test Button and Status -->
            <StackPanel Classes="spacing-tight" IsVisible="{Binding ShowAITestButton}">
                <Button Content="Test Connection"
                        Command="{Binding TestAIBackendCommand}"
                        MinWidth="130"
                        Classes="primary"/>
                <!-- Success message -->
                <TextBlock Text="{Binding AITestStatusMessage}"
                            TextWrapping="Wrap"
                            Classes="small"
                            Foreground="{DynamicResource SuccessColor}"
                            IsVisible="{Binding AITestStatusIsSuccess}"/>
                <!-- Warning/Error message -->
                <TextBlock Text="{Binding AITestStatusMessage}"
                            TextWrapping="Wrap"
                            Classes="small"
                            Foreground="{DynamicResource WarningColor}"
                            IsVisible="{Binding !AITestStatusIsSuccess}"/>
            </StackPanel>
            </StackPanel>
        </Border>
        </StackPanel>
      </WrapPanel>
    </ScrollViewer>

    <!-- Messages and status in separate row -->
    <StackPanel Grid.Row="2" Classes="spacing-tight">
        <TextBlock Text="{Binding StatusMessage}"
                    Foreground="{DynamicResource SuccessColor}"
                    TextWrapping="Wrap"
                    IsVisible="{Binding HasStatusMessage}"/>
        
        <!-- Validation Error Messages with Border (similar to MainView) -->
        <Border Classes="error-container-small"
                IsVisible="{Binding HasValidationErrors}">
          <ItemsControl ItemsSource="{Binding ValidationErrors}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <StackPanel Orientation="Horizontal" Classes="spacing-tight">
                  <TextBlock Text="â€¢" 
                              Classes="error"/>
                  <TextBlock Text="{Binding}" 
                              Classes="small"
                              TextWrapping="Wrap"/>
                </StackPanel>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </Border>
    </StackPanel>

    <!-- Button Section in separate row -->
    <Grid Grid.Row="3" ColumnDefinitions="*,Auto,Auto" Classes="spacing-wide">
      <ProgressBar Grid.Column="0"
                   IsVisible="{Binding IsBusy}"
                   IsIndeterminate="True"/>
      <Button Grid.Column="1"
              Content="Cancel"
              Classes="cancel"
              Command="{Binding CancelCommand}"/>
      <Button Grid.Column="2"
              Content="{Binding OkButtonText}"
              Classes="primary"
              IsDefault="True"
              IsEnabled="{Binding CanSave}"
              Command="{Binding SaveCommand}"/>
    </Grid>

  </Grid>
</UserControl>