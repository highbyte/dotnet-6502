<Project Sdk="Microsoft.NET.Sdk.WebAssembly">
  <PropertyGroup>
    <TargetFramework>net9.0-browser</TargetFramework>
    <OutputType>Exe</OutputType>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <Nullable>enable</Nullable>
    
    <!-- Fix for inclusion of SkiaSharp native assets -->
    <WasmBuildNative>true</WasmBuildNative>

    <!-- WASM SIMD optimization - improves performance -->
    <WasmEnableSIMD>true</WasmEnableSIMD>

    <!-- AOT compilation is not supported for Avalonia Browser WASM with SkiaSharp -->
    <RunAOTCompilation>true</RunAOTCompilation> 

    <!-- Optionally disable aggressive trimming to prevent runtime hangs -->
    <!--<PublishTrimmed>false</PublishTrimmed>-->

    <!-- Emscripten linker optimization - O1 for safety, O2/O3 for more speed -->
    <EmccLinkOptimizationFlag>-O3</EmccLinkOptimizationFlag>

    <!-- Reduce ICU data size for faster loading (unless you need full internationalization) -->
    <InvariantGlobalization>false</InvariantGlobalization>
    <WasmIncludeFullIcuData>false</WasmIncludeFullIcuData>

    <!-- DEBUGGING FIX: Disable problematic debug features for VS2022 -->
    <!--<WasmEnableWebcil>false</WasmEnableWebcil>
    <WasmDebugLevel>0</WasmDebugLevel>-->

  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia.Browser" />
    <!-- <PackageReference Include="SkiaSharp" />
    <PackageReference Include="SkiaSharp.NativeAssets.WebAssembly" /> -->
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Highbyte.DotNet6502.App.Avalonia.Core\Highbyte.DotNet6502.App.Avalonia.Core.csproj" />
  </ItemGroup>

  <Target Name="CopyC64ExampleBinaries" AfterTargets="AfterBuild">
    <Copy SourceFiles="..\..\..\..\samples\Assembler\C64\Raster\Build\smooth_scroller_and_raster.prg" DestinationFolder="wwwroot\6502binaries\C64\Assembler" />
    <Copy SourceFiles="..\..\..\..\samples\Assembler\C64\Raster\Build\scroller_and_raster.prg" DestinationFolder="wwwroot\6502binaries\C64\Assembler" />

    <Copy SourceFiles="..\..\..\..\samples\Basic\C64\Text\Build\HelloWorld.prg" DestinationFolder="wwwroot\6502binaries\C64\Basic" />
    <Copy SourceFiles="..\..\..\..\samples\Basic\C64\Sound\Build\PlaySoundVoice1TriangleScale.prg" DestinationFolder="wwwroot\6502binaries\C64\Basic" />
  </Target>

  <Target Name="CopyGenericExampleBinaries" AfterTargets="AfterBuild">
    <Copy SourceFiles="..\..\..\..\samples\Assembler\Generic\Build\hostinteraction_scroll_text_and_cycle_colors.prg" DestinationFolder="wwwroot\6502binaries\Generic\Assembler" />
    <Copy SourceFiles="..\..\..\..\samples\Assembler\Generic\Build\snake6502.prg" DestinationFolder="wwwroot\6502binaries\Generic\Assembler" />
  </Target>

  <Target Name="CopyImages" AfterTargets="AfterBuild">
    <Copy SourceFiles="..\..\..\..\resources\images\logo.png" DestinationFolder="wwwroot\images" />
  </Target>

</Project>
